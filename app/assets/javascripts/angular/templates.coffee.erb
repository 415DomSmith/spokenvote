<%
template_cache = []
# Pre-fill templateCache with latest templates for all environments
if Rails.env.production? || Rails.env.staging? || Rails.env.development?
  Dir.glob(Rails.root.join("app", "assets", "templates", "**", "*.haml")).each do |f|
    depend_on(f)
    pathname = Pathname(f)
    template = {}
    # /code/railsapp/app/assets/templates/thing -> assets/thing
    template[:dirname] = pathname.dirname.sub(Rails.root.join("app", "assets", "templates").to_s, "assets")
    # /code/railsapp/app/assets/templates/thing/page.html.haml -> page.html
    template[:basename] = pathname.basename(".haml")
    # ["/", "assets/thing", "page.html"] -> /assets/thing/page.html
    template[:path] = File.join("", template[:dirname], template[:basename])
    # Render HAML to HTML
    template[:markup] = Haml::Engine.new(pathname.read).render
    template_cache << template
  end
end
%>
angular.module('spokenvote.templates', []).run(['$templateCache', ($templateCache) ->
    templates = [
        <% template_cache.each do |template| %>
        path: "<%= template[:path] %>"
        markup: """
                <%= template[:markup] %>
                """
    ,
        <% end %>
    ]

    # Pre-fill the Angular cache
    $templateCache.put(template.path, template.markup) for template in templates
])